@page
@model IndexModel
@{
    ViewData["Title"] = "Profile";
    ViewData["ActivePage"] = ManageNavPages.Index;
}

<h4>@ViewData["Title"]</h4>
<partial name="_StatusMessage" model="Model.StatusMessage" />
<div class="row">
    <div class="col-md-6">
        <form id="profile-form" method="post">
            <div id="blabla" asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Username"></label>
                <input id="user-email" asp-for="Username" class="form-control" disabled />
            </div>
            @Html.Partial("~/Views/Shared/_ManagePartial.cshtml", new Dinder.Models.User())
        </form>
    </div>
    <div class="col-md-6">
        <div>
            <picture>
                <img src="~/default-profile-pic.png" id="profilePic" alt="Profile picture">
                <input type="file" id="fileBrowser">
            </picture>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script>
        var pp; //profile pic

        $("#profilePic").click(() => {
            $("#fileBrowser").click();
        });

        $("input:file").change(function () {
            if (this.files && this.files[0] && (this.files[0]["type"]).includes('image')) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#profilePic').attr('src', e.target.result);
                }
                reader.readAsDataURL(this.files[0]);

                pp = $('#fileBrowser').prop('files')[0];
            }
        });

        $(window).on("unload", function (e) {
            //save pp to db
        });

        //Save info on leave
        $(document).ready(function () {
            var data = {
                Email: $("#user-email").val()
            };
            $.ajax({
                type: "POST",
                url: '../../../../api/UserEntities/getProfile',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (result) {
                    $("#name").attr("value", result[0][0].name);
                    $("#phone").attr("value", result[0][0].phone);
                }
            });

            $("#name").on("focusout", function () {
                $("#profile-form").validate();
                if ($("#name").valid()) {
                    var data = {
                        Name: $('#name').val()
                    };
                    $.ajax({
                        type: "POST",
                        url: '../../api/UserEntities/updateName',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function () {
                            //...
                        }
                    });
                }
            });

            $("#phone").on("focusout", function () {
                $("#profile-form").validate();
                if ($("#phone").valid()) {
                    var data = {
                        Phone: $('#phone').val()
                    };
                    $.ajax({
                        type: "POST",
                        url: '../../api/UserEntities/updatePhone',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function () {
                            //...
                        }
                    });
                };

            });
        });
    </script>

    <partial name="_ValidationScriptsPartial" />
}
